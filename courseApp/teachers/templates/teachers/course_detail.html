{% extends "_layout.html" %}
{% load static %}
{% block title %}{{ course.title }}{% endblock %}
{% load tempdict_extras %}

{% block head %}

<style>
  .active-video {
    background-color: #e8f0fe;
    font-weight: bold;
    color: #0d6efd;
  }
</style>

{% endblock %}


{% block content %}
<div class="container py-4">
  <div class="row">

    <!-- üé• Video Player -->
   <div class="col-md-9">
  <div class="card mb-4">
    <div class="card-body">

      <!-- üé• Video -->
      <video id="videoPlayer" class="w-100" controls>
        <source src="{{ video.video_file.url }}" type="video/mp4">
      </video>


      <!-- ‚úÖ S√ºre ve tamamlandƒ± bilgisi -->
      

      <!-- ‚úÖ Video ba≈ülƒ±ƒüƒ± -->
      {% if video %}
    <div class="d-flex justify-content-between mt-2">
        <small class="text-muted">
          ‚è± Time: <span id="videoDuration">{{formatted_duration}}</span>
        </small>
        <small id="completionStatus" class="text-success fw-bold d-none">
          ‚úî Watched
        </small>
      </div>

      <div id="videoInfo" class="mt-2 text-muted small">
        <i class="bi bi-film me-1"></i> <span id="videoTitle">{{ video.title }}</span>
      </div>
      {% endif %}


      <!-- ‚úÖ Not alma alanƒ± -->
    <textarea id="videoNote" name="note" class="form-control" rows="3" placeholder="Take important notes while watching..." style="max-height: 200px; resize: vertical;">{{ existing_note }}</textarea>
    <button id="saveNoteBtn" class="btn btn-success mt-2">Save Note</button>

    </div>
  </div>
</div>


    <!-- üìö Section + Video List -->
<div class="col-md-3">
  <div class="accordion" id="videoAccordion">
    {% for section in course.sections.all %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false"
            aria-controls="collapse{{ forloop.counter }}">
            {{ section.title }}
          </button>
        </h2>
        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse"
          aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#videoAccordion">
          <div class="accordion-body p-0">
            <ul class="list-group list-group-flush">
              {% for video in section.videos.all %}
              <li class="list-group-item p-1 border-0">
                <a href="{% url 'course_detail' course.id %}?video_id={{ video.id }}"
          class="btn d-flex justify-content-between align-items-center text-decoration-none w-100 {% if video.id == selected_video_id %}btn-success active{% endif %}">
          <div class="d-flex align-items-center">
                    <span class="me-2 text-truncate">{{ video.title }}</span>
                    {% if video.id in watched_videos %}
                      <span class="badge bg-success">Watched</span>
                    {% endif %}
                  </div>

                  {% if video_durations|default:""|dict_get:video.id %}
                    <small class=" ms-2" style="black-space: nowrap;">
                      {{ video_durations|dict_get:video.id }}
                    </small>
                  {% endif %}
                  </a>
                </li>
              {% endfor %}

          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>


  </div>

  <!-- Ders ba≈ülƒ±ƒüƒ± ve a√ßƒ±klama -->
  <div class="d-flex justify-content-between align-items-center my-4">
    <div>
      <h1>{{ course.title }}</h1>
      <p>{{ course.description|safe }}</p>
    </div>
    {% if course.teacher == request.user %}
    <a href="{% url 'edit_course_structure' course.id %}" class="btn btn-warning">
      ‚úèÔ∏è Edit Course
    </a>
    {% endif %}
  </div>
</div>
<div id="notification" style="
  display: none;
  position: fixed;
  top: 20px;
  right: 20px;
  background: #198754;
  color: white;
  padding: 10px 20px;
  border-radius: 5px;
  box-shadow: 0 0 5px rgba(0,0,0,0.2);
  z-index: 9999;">
  Note saved!
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const videoPlayer = document.getElementById("mainVideo");
  const saveNoteBtn = document.getElementById("saveNoteBtn");
  const completionStatus = document.getElementById("completionStatus");
  let hasSentWatchData = false;

  // ‚úÖ Send "watched" info to backend when 80% viewed
  if (videoPlayer) {
    const currentVideoId = videoPlayer.getAttribute("data-id");

    videoPlayer.addEventListener("timeupdate", function () {
      const currentTime = videoPlayer.currentTime;
      const duration = videoPlayer.duration;

      if (currentTime / duration >= 0.8 && !hasSentWatchData && currentVideoId) {
        hasSentWatchData = true;

        fetch(`/course/video/${currentVideoId}/watched/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
          },
          body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === "ok" && completionStatus) {
            completionStatus.classList.remove("d-none");
          }
        })
        .catch(err => console.error("Failed to mark as watched:", err));
      }
    });
  }

  // ‚úÖ Save note when "Save" button clicked
  if (saveNoteBtn) {
    saveNoteBtn.addEventListener("click", function (e) {
      e.preventDefault();

      const note = document.getElementById("videoNote").value;
      const videoId = videoPlayer?.getAttribute("data-id");

      fetch(`/course/save_note/${videoId}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({ note: note })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          const notification = document.getElementById("notification");
          if (notification) {
            notification.style.display = "block";
            setTimeout(() => notification.style.display = "none", 2000);
          }
        } else {
          alert("Error: " + (data.message || "Note could not be saved."));
        }
      })
      .catch(() => alert("Server error!"));
    });
  }

  // ‚úÖ Utility: Get CSRF token from cookie
  function getCSRFToken() {
    const cookie = document.cookie
      .split("; ")
      .find(row => row.startsWith("csrftoken="));
    return cookie ? cookie.split("=")[1] : "";
  }
});
</script>








{% endblock %}
