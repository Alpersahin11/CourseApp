{% extends "_layout.html" %}
{% load static %}
{% block title %}{{ course.title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">

    <!-- üé• Video Player -->
   <div class="col-md-8">
  <div class="card mb-3">
    <div class="card-body">

      <!-- üé• Video -->
      <video id="mainVideo" data-id="{{ course.sections.first.videos.first.id }}" width="100%" height="480" controls>
        {% with first_video=course.sections.first.videos.first %}
          {% if first_video %}
            <source src="{{ first_video.video_file.url }}" type="video/mp4">
          {% else %}
            <p>No video available</p>
          {% endif %}
        {% endwith %}
        Your browser does not support the video tag.
      </video>

      <!-- ‚úÖ S√ºre ve tamamlandƒ± bilgisi -->
      <div class="d-flex justify-content-between mt-2">
        <small class="text-muted">
          ‚è± S√ºre: <span id="videoDuration">--:--</span>
        </small>
        <small id="completionStatus" class="text-success fw-bold d-none">
          ‚úî Tamamlandƒ±
        </small>
      </div>

      <!-- ‚úÖ Video ba≈ülƒ±ƒüƒ± -->
      {% with first_video=course.sections.first.videos.first %}
        {% if first_video %}
          <div id="videoInfo" class="mt-2 text-muted small">
            <i class="bi bi-film me-1"></i> <span id="videoTitle">{{ first_video.title }}</span>
          </div>
        {% endif %}
      {% endwith %}

      <!-- ‚úÖ Not alma alanƒ± -->
    <textarea id="videoNote" name="note" class="form-control" rows="3" placeholder="ƒ∞zlerken √∂nemli notlar alƒ±n...">{{ existing_note }}</textarea>
    <button id="saveNoteBtn" class="btn btn-success mt-2">Notu kaydet</button>

    </div>
  </div>
</div>


    <!-- üìö Section + Video List -->
<div class="col-md-4">
  <div class="accordion" id="videoAccordion">
    {% for section in course.sections.all %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ forloop.counter }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false"
            aria-controls="collapse{{ forloop.counter }}">
            {{ section.title }}
          </button>
        </h2>
        <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse"
          aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#videoAccordion">
          <div class="accordion-body p-0">
            <ul class="list-group list-group-flush">
              {% for video in section.videos.all %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <button
                  class="btn p-0 text-start w-100 text-truncate video-btn {% if forloop.first and forloop.parentloop.first %}active-video{% endif %}"
                  data-video-id="{{ video.id }}"
                  data-video-url="{{ video.video_file.url }}"
                  data-video-title="{{ video.title }}"
                >
                  {{ video.title }}
                </button>

                {% if video.duration %}
                  <small class="text-muted ms-2" style="white-space: nowrap;">
                    {{ video.duration|time:"i:s" }}
                  </small>
                {% endif %}

                {% if video.id in watched_videos %}
                  <span class="badge bg-success ms-2">ƒ∞zlendi ‚úî</span>
                {% endif %}
              </li>
            {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>


  </div>

  <!-- Ders ba≈ülƒ±ƒüƒ± ve a√ßƒ±klama -->
  <div class="d-flex justify-content-between align-items-center my-4">
    <div>
      <h1>{{ course.title }}</h1>
      <p>{{ course.description|safe }}</p>
    </div>
    {% if course.teacher == request.user %}
    <a href="{% url 'edit_course_structure' course.id %}" class="btn btn-warning">
      ‚úèÔ∏è Edit Course
    </a>
    {% endif %}
  </div>
</div>

<div id="notification" style="
  display:none;
  position: fixed;
  top: 20px;
  right: 20px;
  background: #198754;
  color: white;
  padding: 10px 20px;
  border-radius: 5px;
  box-shadow: 0 0 5px rgba(0,0,0,0.2);
  z-index: 9999;
">
  Not kaydedildi!
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const videoPlayer = document.getElementById("mainVideo");
  const videoButtons = document.querySelectorAll(".video-btn");
  const videoTitle = document.getElementById("videoTitle");
  const videoDuration = document.getElementById("videoDuration");
  const completionStatus = document.getElementById("completionStatus");

  let currentVideoId = videoPlayer.getAttribute("data-id");
  let hasSentWatchData = false;

  // S√ºre g√∂sterimi
  videoPlayer.addEventListener("loadedmetadata", function () {
    const duration = videoPlayer.duration;
    videoDuration.textContent = formatTime(duration);
    hasSentWatchData = false; // yeni video y√ºklendiƒüinde sƒ±fƒ±rla
  });

  // Video izlenme takibi (%80 izlenince)
  videoPlayer.addEventListener("timeupdate", function () {
    const currentTime = videoPlayer.currentTime;
    const duration = videoPlayer.duration;
    const percentWatched = currentTime / duration;

    if (percentWatched >= 0.8 && !hasSentWatchData && currentVideoId) {
      hasSentWatchData = true;
      fetch(`/course/video/${currentVideoId}/watched/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          completionStatus.classList.remove("d-none");

          // T√ºm butonlardan √∂nceki "ƒ∞zlendi" etiketlerini kaldƒ±r
          videoButtons.forEach(btn => {
            const watchedBadge = btn.parentElement.querySelector(".watched-badge");
            if (watchedBadge) watchedBadge.remove();
          });

          // ≈ûu anki videonun butonuna "ƒ∞zlendi" etiketi ekle
          const currentBtn = Array.from(videoButtons).find(btn => btn.getAttribute("data-video-id") === currentVideoId);
          if (currentBtn && !currentBtn.parentElement.querySelector(".watched-badge")) {
            const badge = document.createElement("span");
            badge.classList.add("watched-badge", "badge", "bg-success", "ms-2");
            badge.textContent = "ƒ∞zlendi ‚úî";
            currentBtn.parentElement.appendChild(badge);
          }
        }
      })
      .catch(err => console.error("ƒ∞zleme durumu kaydedilemedi:", err));
    }
  });

  // Video butonuna tƒ±klanƒ±nca video deƒüi≈ütir
  videoButtons.forEach(button => {
    button.addEventListener("click", function () {
      const url = this.getAttribute("data-video-url");
      const title = this.getAttribute("data-video-title");
      currentVideoId = this.getAttribute("data-video-id");

      videoPlayer.querySelector("source").setAttribute("src", url);
      videoPlayer.setAttribute("data-id", currentVideoId);
      videoPlayer.load();
      videoPlayer.play();

      if (videoTitle) {
        videoTitle.textContent = title;
      }

      if (completionStatus) {
        completionStatus.classList.add("d-none");
      }

      videoButtons.forEach(btn => btn.classList.remove("active-video"));
      this.classList.add("active-video");
    });
  });

  // S√ºre bi√ßimlendirme fonksiyonu
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  }

  // CSRF token al
  function getCSRFToken() {
    const cookieValue = document.cookie
      .split('; ')
      .find(row => row.startsWith('csrftoken='))
      ?.split('=')[1];
    return cookieValue || '';
  }

  // Not kaydet butonu varsa event baƒüla
  const saveNoteBtn = document.getElementById('saveNoteBtn');
  if (saveNoteBtn) {
    saveNoteBtn.addEventListener('click', function(e) {
      e.preventDefault();

      const note = document.getElementById('videoNote').value;
      const videoId = document.getElementById('mainVideo').getAttribute('data-id');
      const csrftoken = getCSRFToken();

      fetch(`/course/save_note/${videoId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({note: note}),
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'ok') {
          const notification = document.getElementById('notification');
          notification.style.display = 'block';

          setTimeout(() => {
            notification.style.display = 'none';
          }, 2000);  // 2 saniye sonra kaybolur
        }
 else {
          alert('Hata: ' + (data.message || 'Not kaydedilemedi.'));
        }
      })
      .catch(() => alert('Sunucu hatasƒ±!'));
    });
  }
});
</script>





<!-- üíÖ Stil: Aktif video i√ßin √∂zel g√∂r√ºn√ºm -->
<style>
  .active-video {
    background-color: #e8f0fe;
    font-weight: bold;
    color: #0d6efd;
  }
</style>
{% endblock %}
